import socket
import threading

def manejar_cliente(cliente, direccion):
    print(f"Conexión establecida desde {direccion[0]}:{direccion[1]}")
    clientes_conectados.append(cliente)

    try:
        while True:
            mensaje = cliente.recv(1024).decode("utf-8")
            if not mensaje:
                break
            print(f"Mensaje de {direccion[0]}:{direccion[1]}: {mensaje}")
            enviar_a_todos(mensaje, cliente)
    except:
        pass

    clientes_conectados.remove(cliente)
    cliente.close()
    print(f"Conexión cerrada desde {direccion[0]}:{direccion[1]}")

def enviar_a_todos(mensaje, cliente_origen):
    for cliente in clientes_conectados:
        if cliente != cliente_origen:
            try:
                cliente.send(mensaje.encode("utf-8"))
            except:
                pass

clientes_conectados = []

servidor = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
servidor.bind(("0.0.0.0", 8080))
servidor.listen()

print("Servidor en espera de conexiones...")

try:
    while True:
        cliente, direccion = servidor.accept()
        cliente_thread = threading.Thread(target=manejar_cliente, args=(cliente, direccion))
        cliente_thread.start()
except KeyboardInterrupt:
    print("Aplicación detenida.")
